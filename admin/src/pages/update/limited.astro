---
/**
 * 限定メニュー更新画面
 */

import AuthLayout from '../../layouts/AuthLayout.astro';
import type { Env, LimitedMenuContent } from '../../lib/types';
import { getContent } from '../../lib/r2';
import { clientImageProcessorCode } from '../../lib/image';

const env = Astro.locals.runtime.env as Env;
const content = await getContent<LimitedMenuContent>(env, 'limited');
---

<AuthLayout title="限定メニュー更新">
  <div class="max-w-lg mx-auto">
    <div class="mb-4">
      <a href="/dashboard" class="text-blue-600 hover:text-blue-800 text-sm">
        ← ダッシュボードに戻る
      </a>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">限定メニューを更新</h2>

      <!-- 現在の内容 -->
      {content && (
        <div class="mb-6">
          <p class="text-sm text-gray-600 mb-2">現在の内容:</p>
          {content.imageUrl && (
            <div class="aspect-[4/3] bg-gray-100 rounded-md overflow-hidden mb-2">
              <img
                src={content.imageUrl}
                alt={content.title}
                class="w-full h-full object-contain"
              />
            </div>
          )}
          <p class="text-sm text-gray-800 font-bold">{content.title}</p>
          <p class="text-sm text-gray-600">{content.description}</p>
        </div>
      )}

      <!-- エラーメッセージ -->
      <div
        id="error-message"
        class="hidden mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-md"
      ></div>

      <!-- 成功メッセージ -->
      <div
        id="success-message"
        class="hidden mb-4 p-3 bg-green-100 text-green-700 text-sm rounded-md"
      ></div>

      <!-- テキスト更新フォーム -->
      <form id="text-form" class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            タイトル
          </label>
          <input
            type="text"
            id="title"
            name="title"
            value={content?.title || ''}
            required
            maxlength="50"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            説明文
          </label>
          <textarea
            id="description"
            name="description"
            rows="3"
            maxlength="200"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >{content?.description || ''}</textarea>
        </div>

        <button
          type="submit"
          id="text-submit-btn"
          class="w-full py-2 px-4 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          テキストを保存
        </button>
      </form>

      <hr class="my-6" />

      <!-- 画像アップロードフォーム -->
      <h3 class="text-lg font-bold text-gray-800 mb-4">画像を変更</h3>

      <form id="image-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            メニュー画像
          </label>
          <input
            type="file"
            id="image"
            name="image"
            accept="image/jpeg,image/png,image/webp"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">
            JPEG, PNG, WebP（10MB以下）。長辺2000pxにリサイズされます。
          </p>
        </div>

        <!-- プレビュー -->
        <div id="preview-container" class="hidden">
          <p class="text-sm text-gray-600 mb-2">プレビュー:</p>
          <div class="aspect-[4/3] bg-gray-100 rounded-md overflow-hidden">
            <img id="preview-image" src="" alt="プレビュー" class="w-full h-full object-contain" />
          </div>
        </div>

        <button
          type="submit"
          id="image-submit-btn"
          class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          画像をアップロード
        </button>
      </form>
    </div>
  </div>

  <script set:html={clientImageProcessorCode}></script>
  <script>
    const textForm = document.getElementById('text-form') as HTMLFormElement;
    const imageForm = document.getElementById('image-form') as HTMLFormElement;
    const imageInput = document.getElementById('image') as HTMLInputElement;
    const previewContainer = document.getElementById('preview-container') as HTMLDivElement;
    const previewImage = document.getElementById('preview-image') as HTMLImageElement;
    const errorDiv = document.getElementById('error-message') as HTMLDivElement;
    const successDiv = document.getElementById('success-message') as HTMLDivElement;
    const textSubmitBtn = document.getElementById('text-submit-btn') as HTMLButtonElement;
    const imageSubmitBtn = document.getElementById('image-submit-btn') as HTMLButtonElement;

    function showError(message: string) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      successDiv.classList.add('hidden');
    }

    function showSuccess(message: string) {
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      errorDiv.classList.add('hidden');
    }

    // 画像プレビュー
    imageInput.addEventListener('change', async () => {
      const file = imageInput.files?.[0];
      if (!file) {
        previewContainer.classList.add('hidden');
        return;
      }

      try {
        // @ts-ignore
        const { blob } = await processImageOnClient(file);
        previewImage.src = URL.createObjectURL(blob);
        previewContainer.classList.remove('hidden');
      } catch (error: any) {
        showError(error.message);
      }
    });

    // テキスト保存
    textForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      textSubmitBtn.disabled = true;
      textSubmitBtn.textContent = '保存中...';

      const title = (document.getElementById('title') as HTMLInputElement).value;
      const description = (document.getElementById('description') as HTMLTextAreaElement).value;

      try {
        const response = await fetch('/api/content', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'limited', title, description }),
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('テキストを保存しました。');
        } else {
          showError(data.error || '保存に失敗しました。');
        }
      } catch (error: any) {
        showError(error.message || 'エラーが発生しました。');
      } finally {
        textSubmitBtn.disabled = false;
        textSubmitBtn.textContent = 'テキストを保存';
      }
    });

    // 画像アップロード
    imageForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = imageInput.files?.[0];
      if (!file) {
        showError('画像を選択してください。');
        return;
      }

      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      imageSubmitBtn.disabled = true;
      imageSubmitBtn.textContent = 'アップロード中...';

      try {
        // 画像を処理（リサイズ + WebP変換）
        // @ts-ignore
        const { blob } = await processImageOnClient(file);

        // FormData を作成
        const formData = new FormData();
        formData.append('image', blob, 'limited.webp');
        formData.append('type', 'limited');

        // アップロード
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('画像をアップロードしました。');
          // 少し待ってからリロード
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showError(data.error || 'アップロードに失敗しました。');
        }
      } catch (error: any) {
        showError(error.message || 'エラーが発生しました。');
      } finally {
        imageSubmitBtn.disabled = false;
        imageSubmitBtn.textContent = '画像をアップロード';
      }
    });
  </script>
</AuthLayout>
