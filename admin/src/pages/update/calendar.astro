---
/**
 * カレンダー更新画面
 */

import AuthLayout from '../../layouts/AuthLayout.astro';
import type { Env, CalendarContent } from '../../lib/types';
import { getContent } from '../../lib/r2';
import { clientImageProcessorCode } from '../../lib/image';

const env = Astro.locals.runtime.env as Env;
const content = await getContent<CalendarContent>(env, 'calendar');

// 今月と来月の選択肢を生成
const now = new Date();
const months = [
  { value: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`, label: `${now.getFullYear()}年${now.getMonth() + 1}月` },
  { value: `${now.getFullYear()}-${String(now.getMonth() + 2).padStart(2, '0')}`, label: `${now.getFullYear()}年${now.getMonth() + 2}月` },
];
// 12月の場合は来月が翌年になる
if (now.getMonth() === 11) {
  months[1] = { value: `${now.getFullYear() + 1}-01`, label: `${now.getFullYear() + 1}年1月` };
}
---

<AuthLayout title="カレンダー更新">
  <div class="max-w-lg mx-auto">
    <div class="mb-4">
      <a href="/dashboard" class="text-blue-600 hover:text-blue-800 text-sm">
        ← ダッシュボードに戻る
      </a>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">営業カレンダーを更新</h2>

      <!-- 現在の画像 -->
      {content && (
        <div class="mb-6">
          <p class="text-sm text-gray-600 mb-2">現在の画像:</p>
          <div class="aspect-[4/3] bg-gray-100 rounded-md overflow-hidden">
            <img
              src={content.imageUrl}
              alt={`${content.month} のカレンダー`}
              class="w-full h-full object-contain"
            />
          </div>
          <p class="text-sm text-gray-500 mt-1">対象月: {content.month}</p>
        </div>
      )}

      <!-- エラーメッセージ -->
      <div
        id="error-message"
        class="hidden mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-md"
      ></div>

      <!-- 成功メッセージ -->
      <div
        id="success-message"
        class="hidden mb-4 p-3 bg-green-100 text-green-700 text-sm rounded-md"
      ></div>

      <!-- アップロードフォーム -->
      <form id="upload-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            対象月
          </label>
          <select
            id="month"
            name="month"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            {months.map((m) => (
              <option value={m.value} selected={content?.month === m.value}>
                {m.label}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            カレンダー画像
          </label>
          <input
            type="file"
            id="image"
            name="image"
            accept="image/jpeg,image/png,image/webp"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">
            JPEG, PNG, WebP（10MB以下）。長辺2000pxにリサイズされます。
          </p>
        </div>

        <!-- プレビュー -->
        <div id="preview-container" class="hidden">
          <p class="text-sm text-gray-600 mb-2">プレビュー:</p>
          <div class="aspect-[4/3] bg-gray-100 rounded-md overflow-hidden">
            <img id="preview-image" src="" alt="プレビュー" class="w-full h-full object-contain" />
          </div>
        </div>

        <button
          type="submit"
          id="submit-btn"
          class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          アップロード
        </button>
      </form>
    </div>
  </div>

  <script set:html={clientImageProcessorCode}></script>
  <script>
    const form = document.getElementById('upload-form') as HTMLFormElement;
    const imageInput = document.getElementById('image') as HTMLInputElement;
    const previewContainer = document.getElementById('preview-container') as HTMLDivElement;
    const previewImage = document.getElementById('preview-image') as HTMLImageElement;
    const errorDiv = document.getElementById('error-message') as HTMLDivElement;
    const successDiv = document.getElementById('success-message') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    // 画像プレビュー
    imageInput.addEventListener('change', async () => {
      const file = imageInput.files?.[0];
      if (!file) {
        previewContainer.classList.add('hidden');
        return;
      }

      try {
        // @ts-ignore
        const { blob } = await processImageOnClient(file);
        previewImage.src = URL.createObjectURL(blob);
        previewContainer.classList.remove('hidden');
      } catch (error: any) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });

    // フォーム送信
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'アップロード中...';

      const file = imageInput.files?.[0];
      const month = (document.getElementById('month') as HTMLSelectElement).value;

      if (!file) {
        errorDiv.textContent = '画像を選択してください。';
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'アップロード';
        return;
      }

      try {
        // 画像を処理（リサイズ + WebP変換）
        // @ts-ignore
        const { blob } = await processImageOnClient(file);

        // FormData を作成
        const formData = new FormData();
        formData.append('image', blob, 'calendar.webp');
        formData.append('type', 'calendar');
        formData.append('month', month);

        // アップロード
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          successDiv.textContent = 'アップロードが完了しました。';
          successDiv.classList.remove('hidden');
          // 少し待ってからリダイレクト
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 1500);
        } else {
          errorDiv.textContent = data.error || 'アップロードに失敗しました。';
          errorDiv.classList.remove('hidden');
        }
      } catch (error: any) {
        errorDiv.textContent = error.message || 'エラーが発生しました。';
        errorDiv.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'アップロード';
      }
    });
  </script>
</AuthLayout>
