---
/**
 * OGP設定更新画面
 */

import AuthLayout from '../../layouts/AuthLayout.astro';
import type { Env, OgpContent } from '../../lib/types';
import { getContent } from '../../lib/r2';
import { clientOgpImageProcessorCode } from '../../lib/image';

const env = Astro.locals.runtime.env as Env;
const content = await getContent<OgpContent>(env, 'ogp');
---

<AuthLayout title="SNSシェアカード設定(OGP)">
  <div class="max-w-lg mx-auto">
    <div class="mb-4">
      <a href="/dashboard" class="text-blue-600 hover:text-blue-800 text-sm">
        ← ダッシュボードに戻る
      </a>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-2">SNSシェアカード設定(OGP)</h2>
      <p class="text-sm text-gray-500 mb-4">
        SNSでシェアされた際に表示される情報を設定します。
      </p>

      <!-- エラーメッセージ -->
      <div
        id="error-message"
        class="hidden mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-md"
      ></div>

      <!-- 統合フォーム -->
      <form id="update-form" class="space-y-4">
        <!-- タイトル -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            タイトル
          </label>
          <input
            type="text"
            id="title"
            name="title"
            value={content?.title || ''}
            required
            maxlength="60"
            placeholder="例: サンプル店舗 - サービス名"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">60文字以内推奨</p>
        </div>

        <!-- 説明文 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            説明文
          </label>
          <textarea
            id="description"
            name="description"
            rows="3"
            maxlength="160"
            placeholder="例: サービスの説明文をここに入力します。"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >{content?.description || ''}</textarea>
          <p class="text-xs text-gray-500 mt-1">160文字以内推奨</p>
        </div>

        <!-- 画像（任意） -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            シェア画像（OGP画像）
          </label>
          <!-- ドラッグ&ドロップエリア -->
          <div
            id="drop-zone"
            class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center cursor-pointer hover:border-blue-400 transition-colors"
          >
            <input
              type="file"
              id="image"
              name="image"
              accept="image/jpeg,image/png,image/webp,image/heic,image/heif"
              class="hidden"
            />
            <div id="drop-zone-text">
              <p class="text-gray-600 mb-1">ここにファイルをドロップ</p>
              <p class="text-gray-400 text-sm">または クリックして選択</p>
            </div>
            <div id="file-selected" class="hidden">
              <p class="text-gray-800 font-medium" id="file-name"></p>
              <button
                type="button"
                id="clear-file"
                class="text-red-500 text-sm mt-1 hover:text-red-700"
              >
                取り消す
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            1200×630pxに自動リサイズ（中央トリミング）。WebP形式で保存。
          </p>
        </div>

        <!-- プレビュー -->
        <div id="preview-container" class="hidden">
          <p class="text-sm text-gray-600 mb-2">プレビュー:</p>
          <div class="aspect-[1200/630] bg-gray-100 rounded-md overflow-hidden">
            <img id="preview-image" src="" alt="プレビュー" class="w-full h-full object-cover" />
          </div>
        </div>

        <!-- 現在の画像 -->
        {content?.imageUrl && (
          <div>
            <p class="text-sm text-gray-600 mb-2">現在の画像:</p>
            <div class="aspect-[1200/630] bg-gray-100 rounded-md overflow-hidden">
              <img src={content.imageUrl} alt="現在のOGP画像" class="w-full h-full object-cover" />
            </div>
          </div>
        )}

        <button
          type="submit"
          id="submit-btn"
          class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          保存
        </button>
      </form>
    </div>

    <!-- OGPプレビュー（カード形式） -->
    <div class="mt-6 bg-white rounded-lg shadow-sm p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">プレビュー（シェア時の表示イメージ）</h3>
      <div class="border rounded-lg overflow-hidden max-w-md">
        <div id="card-preview-image" class="aspect-[1200/630] bg-gray-200">
          {content?.imageUrl && (
            <img src={content.imageUrl} alt="OGP" class="w-full h-full object-cover" />
          )}
        </div>
        <div class="p-3 bg-gray-50">
          <p id="card-preview-url" class="text-xs text-gray-500 mb-1">example.com</p>
          <p id="card-preview-title" class="font-bold text-gray-800 text-sm line-clamp-2">{content?.title || 'タイトル未設定'}</p>
          <p id="card-preview-description" class="text-xs text-gray-600 mt-1 line-clamp-2">{content?.description || '説明文未設定'}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- heic2any ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script set:html={clientOgpImageProcessorCode}></script>
  <script>
    const form = document.getElementById('update-form') as HTMLFormElement;
    const imageInput = document.getElementById('image') as HTMLInputElement;
    const dropZone = document.getElementById('drop-zone') as HTMLDivElement;
    const dropZoneText = document.getElementById('drop-zone-text') as HTMLDivElement;
    const fileSelected = document.getElementById('file-selected') as HTMLDivElement;
    const fileNameEl = document.getElementById('file-name') as HTMLParagraphElement;
    const clearFileBtn = document.getElementById('clear-file') as HTMLButtonElement;
    const previewContainer = document.getElementById('preview-container') as HTMLDivElement;
    const previewImage = document.getElementById('preview-image') as HTMLImageElement;
    const errorDiv = document.getElementById('error-message') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    // カードプレビュー要素
    const cardPreviewTitle = document.getElementById('card-preview-title') as HTMLParagraphElement;
    const cardPreviewDescription = document.getElementById('card-preview-description') as HTMLParagraphElement;
    const titleInput = document.getElementById('title') as HTMLInputElement;
    const descriptionInput = document.getElementById('description') as HTMLTextAreaElement;

    let currentFile: File | null = null;
    let processedResult: { blob: Blob; isPng: boolean } | null = null;

    // リアルタイムプレビュー更新
    titleInput.addEventListener('input', () => {
      cardPreviewTitle.textContent = titleInput.value || 'タイトル未設定';
    });

    descriptionInput.addEventListener('input', () => {
      cardPreviewDescription.textContent = descriptionInput.value || '説明文未設定';
    });

    // ドロップゾーンクリック
    dropZone.addEventListener('click', () => {
      imageInput.click();
    });

    // ドラッグイベント
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');

      const files = e.dataTransfer?.files;
      if (files && files.length > 0) {
        await handleFile(files[0]);
      }
    });

    // ファイル選択
    imageInput.addEventListener('change', async () => {
      const file = imageInput.files?.[0];
      if (file) {
        await handleFile(file);
      }
    });

    // ファイル取り消し
    clearFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      currentFile = null;
      processedResult = null;
      imageInput.value = '';
      dropZoneText.classList.remove('hidden');
      fileSelected.classList.add('hidden');
      previewContainer.classList.add('hidden');
    });

    async function handleFile(file: File) {
      currentFile = file;
      errorDiv.classList.add('hidden');

      // ファイル名表示
      fileNameEl.textContent = file.name;
      dropZoneText.classList.add('hidden');
      fileSelected.classList.remove('hidden');

      try {
        // @ts-ignore
        const result = await processOgpImageOnClient(file);
        processedResult = result;
        previewImage.src = URL.createObjectURL(result.blob);
        previewContainer.classList.remove('hidden');

        // カードプレビューも更新
        const cardImage = document.querySelector('#card-preview-image img') as HTMLImageElement | null;
        if (cardImage) {
          cardImage.src = previewImage.src;
        } else {
          const cardPreviewContainer = document.getElementById('card-preview-image');
          if (cardPreviewContainer) {
            cardPreviewContainer.innerHTML = `<img src="${previewImage.src}" alt="OGP" class="w-full h-full object-cover" />`;
          }
        }
      } catch (error: any) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        previewContainer.classList.add('hidden');
        processedResult = null;
      }
    }

    // フォーム送信
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      errorDiv.classList.add('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = '保存中...';

      const title = titleInput.value;
      const description = descriptionInput.value;

      try {
        // 画像がある場合は先にアップロード
        if (processedResult) {
          const formData = new FormData();
          formData.append('image', processedResult.blob, 'ogp.webp');
          formData.append('type', 'ogp');
          formData.append('isPng', 'false');

          const uploadResponse = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          });

          const uploadData = (await uploadResponse.json()) as { success: boolean; error?: string };

          if (!uploadData.success) {
            throw new Error(uploadData.error || '画像のアップロードに失敗しました。');
          }
        }

        // テキストを保存
        const response = await fetch('/api/content', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'ogp', title, description }),
        });

        const data = (await response.json()) as { success: boolean; error?: string };

        if (data.success) {
          // 成功→ダッシュボードに遷移
          window.location.href = '/dashboard';
        } else {
          errorDiv.textContent = data.error || '保存に失敗しました。';
          errorDiv.classList.remove('hidden');
        }
      } catch (error: any) {
        errorDiv.textContent = error.message || 'エラーが発生しました。';
        errorDiv.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '保存';
      }
    });
  </script>
</AuthLayout>
